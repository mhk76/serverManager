"use strict";exports.serverManagerTools=function(){let e={},t=new Event("websocket_onconnect"),r=new Event("websocket_ondisconnect"),o=null,s=[],a={},n,c,l={},i,u="https"===location.protocol?"wss://":"ws://",d={};const g={cookie:{read:e=>{let t=escape(e)+"=";document.cookie.split("; ").foreach(e=>{if(e.substr(0,t.length)===t)return unescape(e.substr(t.length))})},write:(e,t,r)=>{document.cookie=escape(e)+"="+escape(t)+(r?"; max-age="+r:"")},delete:e=>{document.cookie=escape(e)+"=; max-age=-1"}},http:{options:{postDelay:10,permanentId:!1},fetch:(t,r)=>{if(e[t]&&_tools.equals(r,e[t].parameters)){let r=Promise.resolve(e[t].response);return e[t].isPermanent||delete e[t],r}return new Promise((n,c)=>{let l=(new Date).getTime()+Math.random(),i;a[l]={resolve:n,reject:c},i=localStorage&&localStorage.getItem?localStorage.userId:cookie.read("userId");let u={requestId:l,action:t};r&&(u.parameters=r),s.push(u),o&&clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),o=null;let t={actions:s};i&&(t.userId=i),fetch("/",{method:"POST",cache:"no-cache",body:JSON.stringify(t)}).then(t=>{t.userId&&(g.http.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):cookie.write("userId",t.userId,g.http.options.permanentId&&31536e4)),Object.assign(e,t.buffer);for(let e in t.responses){let r=t.responses[e];if("error"===r.status)return void a[e].reject(r.data);a[e].resolve(r.data),delete a[e]}},e=>{t.actions.forEach(t=>{a[t.requestId].reject(e.statusText)})}),s=[]},g.http.options.postDelay||10)})}},webSocket:{options:{},loader:new Promise((e,t)=>{i={resolve:e,reject:t}}),supported:!!WebSocket,start:e=>(g.webSocket.optios=e,c=new S,i),addListener:(e,t)=>{l[e]=t},fetch:(t,r)=>{if(e[t]&&$.equals(r,e[t].parameters)){let r=Promise.resolve(e[t].response);return e[t].isPermanent||delete e[t],r}let o={requestId:(new Date).getTime()+Math.random(),action:t},s;(s=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:cookie.read("userId"))&&(o.userId=s),r&&(o.parameters=r);let a=new Promise((e,t)=>{d[o.requestId]={resolve:e,reject:t}}).catch(e=>{});return 1===c.readyState?c.send(JSON.stringify(o)):a.reject(),a}},server:{loader:new Promise((e,t)=>{n={resolve:e,reject:t}}),start:e=>{let t=[];return(e=e||{}).webSocket=!!e.webSocket&&g.webSocket.supported,g.http.options=e,e.webSocket&&t.push(g.webSocket.start(e)),Promise.all(t).then(()=>{e.webSocket?(g.server.fetch=g.webSocket.fetch,g.server.addListener=g.webSocket.addListener,g.server.usingWebSocket=!0):(g.server.fetch=g.http.fetch,g.server.addListener=(()=>{}),g.server.usingWebSocket=!1),n.resolve()}),n},readStore:(e,t)=>{let r;if(void 0===(r=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(r)}catch(e){return t}},writeStore:(e,t,r)=>{r&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),r)},deleteStore:e=>{localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}},equals:(e,t,r)=>{if(e===t||r&&e==t)return!0;if(isNaN(e))return isNaN(t);let o=typeof e;if(o!==typeof t||["string","number","boolean"].includes(o)||["string","number","boolean"].includes(type2))return!1;if(Array.isArray(e))return!!Array.isArray(t)&&(e.length===t.length&&e.every((e,o)=>_tools.equals(e,t[o],r)));if(e instanceof Date)return+e==+t;if(e instanceof Function||t instanceof Function)return!1;const s=Object.getOwnPropertyNames(e),a=Object.getOwnPropertyNames(t);return s.length===a.length&&s.every((o,s)=>o===keys[s]&&(e[o]instanceof Function?t[o]instanceof Function:_tools.equals(e[o],t[o],r)))}};return g.webSocket.supported||i.resolve(),g;function S(){let o=new WebSocket(u+location.host);return o.onmessage=(t=>{try{let r=JSON.parse(t.data),o=d[r.requestId];if("error"===r.status)return void o.reject(r.data);r.buffer&&Object.assign(e,r.buffer),r.userId&&(g.webSocket.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",r.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",r.userId):cookie.write("userId",r.userId,g.webSocket.options.permanentId&&31536e4));for(let e in l)if(e===r.requestId)return void l[e](r.data);o.resolve(r.data)}catch(e){console.log(e)}}),o.onopen=(()=>{document.dispatchEvent(t),i.resolve()}),o.onclose=(()=>{document.dispatchEvent(r)&&(c=new S)}),o}}();