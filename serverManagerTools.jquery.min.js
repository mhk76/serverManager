"use strict";const serverManagerTools=function(){let e={},t=new Event("websocket_onconnect"),s=new Event("websocket_ondisconnect"),o=null,r=[],n={},i,a={},c={},l="https"===location.protocol?"wss://":"ws://",d={cookie:{read:function(e){let t=document.cookie.split("; "),s=escape(e)+"=";for(let e in t)if(e.substr(0,s.length)===s)return unescape(e.substr(s.length))},write:function(e,t,s){document.cookie=escape(e)+"="+escape(t)+(s?"; max-age="+s:"")},delete:function(e){document.cookie=escape(e)+"=; max-age=-1"}},http:{options:{postDelay:10},fetch:function(t,s){let i=$.Deferred();if(e[t]&&$.equals(s,e[t].parameters))return i.resolve(e[t].response),e[t].isPermanent||delete e[t],i;let a=(new Date).getTime()+Math.random(),c;n[a]=i,c=sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:cookie.read("sessionId");let l={requestId:a,action:t};return s&&(l.parameters=s),r.push(l),o&&clearTimeout(o),o=setTimeout(function(){clearTimeout(o),o=null;let t={actions:r};c&&(t.sessionId=c),$.post({method:"POST",url:"/",data:JSON.stringify(t)}).then(function(t){sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("sessionId",t.sessionId):cookie.write("sessionId",t.sessionId),e=$.extend(e,t.buffer);for(let e in t.responses){let s=t.responses[e];if("error"===s.status)return void i.reject(s.data);n[e].resolve(s.data),delete n[e]}},function(e,t){i.reject(e.statusText)}),r=[]},d.http.options.postDelay||10),i}},webSocket:{options:{},loader:$.Deferred(),supported:!!WebSocket,start:function(e){return d.webSocket.optios=e,i=new u,d.webSocket.loader},addListener:function(e,t){c[e]=t},fetch:function(t,s){if(e[t]&&$.equals(s,e[t].parameters)){let s=$.Deferred();return s.resolve(e[t].response),e[t].isPermanent||delete e[t],s}let o={requestId:(new Date).getTime()+Math.random(),action:t},r;(r=sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:cookie.read("sessionId"))&&(o.sessionId=r),s&&(o.parameters=s);let n=a[o.requestId]=$.Deferred();return 1===i.readyState?i.send(JSON.stringify(o)):n.reject(),n}},server:{loader:$.Deferred(),start:function(e){let t=[];return(e=e||{}).webSocket=!!e.webSocket&&d.webSocket.supported,d.http.options=e,e.webSocket&&t.push(d.webSocket.start(e)),$.when(t).then(function(){e.webSocket?(d.server.fetch=d.webSocket.fetch,d.server.addListener=d.webSocket.addListener,d.server.usingWebSocket=!0):(d.server.fetch=d.http.fetch,d.server.addListener=function(){},d.server.usingWebSocket=!1),d.server.loader.resolve()}),d.server.loader},readStore:function(e,t){let s;if(void 0===(s=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(s)}catch(e){return t}},writeStore:function(e,t,s){s&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),s)},deleteStore:function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)},sessionId:function(){return sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:cookie.read("sessionId")}},setUnselectable:function(e){e.onselectstart=function(){return!1},e.style.MozUserSelect="none",e.style.KhtmlUserSelect="none",e.unselectable="on"}};return d.webSocket.supported||d.webSocket.loader.resolve(),d;function u(){let o=new WebSocket(l+location.host);return o.onmessage=function(t){try{let s=JSON.parse(t.data),o=a[s.requestId];if("error"===s.status)return void o.reject(s.data);s.buffer&&(e=$.extend(e,s.buffer)),sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("sessionId",s.sessionId):cookie.write("sessionId",s.sessionId);for(let e in c)if(e===s.requestId)return void c[e](s.data);o.resolve(s.data)}catch(e){console.log(e)}},o.onopen=function(){document.dispatchEvent(t),d.webSocket.loader.resolve()},o.onclose=function(){document.dispatchEvent(s)&&(i=new u)},o}}();