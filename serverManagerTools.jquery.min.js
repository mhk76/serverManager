"use strict";const serverManagerTools=function(){let e={},t=null,o=new Event("setdictionarylanguage"),n=[],r=[],a=-1,s={},c=null,l=[],i={},d,u={},g={},p="https"===location.protocol?"wss://":"ws://",f={dictionary:{loader:$.Deferred(),start:function(){return $.get("dictionary.json").then(function(o){e=o;for(let o in window.navigator.languages){let n=window.navigator.languages[o];if(e[n]){t=n;break}if(5===n.length&&e[n.substr(0,2)]){t=n.substr(0,2);break}}null===t&&(t=Object.keys(e)[0]),f.dictionary.lang=t,f.dictionary.loader.resolve()},function(e){throw"Failed to load dictionary"}),f.dictionary.loader},lang:null,setLang:function(n){return!!e[n]&&(t=n,document.dispatchEvent(o),!0)},get:function(o,n,r){return void 0===r&&"string"==typeof n?e[t]&&e[t][o]||n:void 0===n?e[t]&&e[t][o]||r||o:e[t]&&e[t][o]&&e[t][o][n]||o+n},getLanguages:function(){let t={};for(let o in e)t[o]=e[o]._lang;return Object.keys(t).length>1?t:{}},formatDate:function(o,n){"string"==typeof o&&(o=new Date(o));let r=e[t][n||"_date"]||"%yyyy-%mm-%dd",a=o.getMonth()+1,s=o.getDate(),c=o.getHours(),l=o.getMinutes();return-1===r.indexOf("%a")?r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace("%yyyy",o.getFullYear())).replace("%yy",o.getYear())).replace("%dd",m(s,2,"0"))).replace("%d",s)).replace("%mm",m(a,2,"0"))).replace("%m",a)).replace("%hh",m(c,2,"0"))).replace("%h",c)).replace("%nn",m(l,2,"0"))).replace("%n",l):(r=(r=(r=(r=(r=(r=(r=(r=r.replace("%yyyy",o.getFullYear())).replace("%yy",o.getYear())).replace("%mm",m(a,2,"0"))).replace("%m",a)).replace("%dd",m(s,2,"0"))).replace("%d",s)).replace("%nn",m(l,2,"0"))).replace("%n",l),c>=12?(r=r.replace("%a","PM"),c-=12):r=r.replace("%a","AM"),c=0===c?12:c,r=(r=r.replace("%hh",m(c,2,"0"))).replace("%h",c)),r}},showDialog:function(e,t,o){return document.body.style.overflow="hidden",function(s){let c;if(n[s]||(n[s]=$('<div class="smDialog level'+s%3+'"><span class="message"></span><p></p><div class="buttons"></div></div>'),r[s]=$('<div class="smDialogMask level'+s%3+'"></div>'),$(document.body).append(n[s]).append(r[s])),Array.isArray(e)){c=f.dictionary.get(e[0]);for(let t=1;t<e.length;t++)c=c.replace(e[t].key,f.dictionary.get(e[t].message,e[t].index))}else c=f.dictionary.get(e);let l=n[s],i=r[s],d=l.find("p"),u=l.find("div"),g={},p,m={},y=[];if(l.find("span").text(c),d.empty(),u.empty(),o)for(let e=0;e<o.length;e++){let t=o[e],n=$("<span></span>");switch(n.attr("class",t.class),t.type){case"text":n.text(f.dictionary.get(t.text));break;case"html":n.html(t.html);break;case"input":case"email":case"number":case"range":case"search":{let o=$("<input/>");o.attr("type","input"===t.type?"text":t.type),o.attr("maxlength",t.maxlength),o.attr("min",t.min),o.attr("max",t.max),o.attr("step",t.step),o.attr("value",t.default),t.placeholder&&o.attr("placeholder",f.dictionary.get(t.placeholder)),t.onchange&&o.bind("change",t.onchange),g[t.name||t.type+e]=o,p||(p=o),n.append(o);break}}d.append(n)}t||(t=[{text:"close",default:!0,cancel:!0}]);for(let e=0;e<t.length;e++){let o=t[e],n=$("<button></button>");n.text(f.dictionary.get(o.text,o.index)),n[0].clickEvent=o.onclick,n.on("click",function(){if(this.clickEvent){let e=this.clickEvent(g);if(e)return void(e.then&&e.then(function(){k()}))}k()}),o.default&&(m.Enter=n),o.cancel&&(m.Escape=n),o.hotkey&&(m[o.hotkey]=n),u.append(n)}function h(e){if(-1!==y.indexOf(e.key)&&s===a)return m[e.key][0].click(),e.stopImmediatePropagation(),!0}return Object.keys(m).length>0&&(y=Object.keys(m),window.addEventListener("keydown",h)),i.css({"z-index":1e3+2*s}).show(),l.css({"z-index":1e3+2*s+1}).show(),p&&(p[0].focus(),p[0].select&&p[0].select()),k;function k(){n[s].hide(),r[s].hide(),--a,window.removeEventListener("keydown",h),-1===a&&(document.body.style.overflow="")}}(++a)},dialog:{ok:function(e){f.showDialog(e)},yesNo:function(e,t,o){f.showDialog(e,[{text:"yes",hotkey:f.dictionary.get("yes-key"),default:!0,onclick:t},{text:"no",hotkey:f.dictionary.get("no-key"),cancel:!0,onclick:o}])},input:function(e,t,o,n){o&&!$.isFunction(o)&&(n||(n=o),o=function(){}),f.showDialog(e,[{text:"ok",default:!0,onclick:function(e){return t(e.inputText.val())}},{text:"cancel",cancel:!0,onclick:o}],[{type:"input",name:"inputText",default:n}])}},cookie:{read:function(e){let t=document.cookie.split("; "),o=escape(e)+"=";for(let e in t)if(e.substr(0,o.length)===o)return unescape(e.substr(o.length))},write:function(e,t,o){document.cookie=escape(e)+"="+escape(t)+(o?"; max-age="+o:"")},delete:function(e){document.cookie=escape(e)+"=; max-age=-1"}},http:{options:{postDelay:10,permanentId:!1},fetch:function(e,t){let o=$.Deferred();if(s[e]&&$.equals(t,s[e].parameters))return o.resolve(s[e].response),s[e].isPermanent||delete s[e],o;let n=(new Date).getTime()+Math.random(),r;i[n]=o,r=localStorage&&localStorage.getItem?localStorage.userId:cookie.read("userId");let a={requestId:n,action:e};return t&&(a.parameters=t),l.push(a),c&&clearTimeout(c),c=setTimeout(function(){clearTimeout(c),c=null;let e={actions:l};r&&(e.userId=r),$.post({method:"POST",url:"/",data:JSON.stringify(e)}).then(function(e){e.userId&&(f.http.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",e.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",e.userId):cookie.write("userId",e.userId,f.http.options.permanentId&&31536e4)),s=$.extend(s,e.buffer);for(let t in e.responses){let n=e.responses[t];if("error"===n.status)return dialog.ok(n.data),void o.reject(n.data);i[t].resolve(n.data),delete i[t]}},function(e,t){dialog.ok(e.statusText),o.reject(e.statusText)}),l=[]},f.http.options.postDelay||10),o}},webSocket:{options:{},loader:$.Deferred(),onconnect:null,ondisconnect:null,supported:!!WebSocket,start:function(e){return f.webSocket.optios=e,d=new y,f.webSocket.loader},addListener:function(e,t){g[e]=t},fetch:function(e,t){if(s[e]&&$.equals(t,s[e].parameters)){let t=$.Deferred();return t.resolve(s[e].response),s[e].isPermanent||delete s[e],t}let o={requestId:(new Date).getTime()+Math.random(),action:e},n;(n=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:cookie.read("userId"))&&(o.userId=n),t&&(o.parameters=t);let r=u[o.requestId]=$.Deferred();return 1===d.readyState?d.send(JSON.stringify(o)):r.reject(),r}},server:{loader:$.Deferred(),start:function(e){let t=[];return(e=e||{}).webSocket=!!e.webSocket&&f.webSocket.supported,f.http.options=e,e.webSocket&&t.push(f.webSocket.start(e)),$.when(t).then(function(){e.webSocket?(f.server.fetch=f.webSocket.fetch,f.server.addListener=f.webSocket.addListener,f.server.usingWebSocket=!0,f.webSocket.onconnect=e.onconnect,f.webSocket.ondisonnect=e.ondisconnect):(f.server.fetch=f.http.fetch,f.server.addListener=function(){},f.server.usingWebSocket=!1),f.server.loader.resolve()}),f.server.loader},readStore:function(e,t){let o;if(void 0===(o=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(o)}catch(e){return t}},writeStore:function(e,t,o){o&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),o)},deleteStore:function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}},setUnselectable:function(e){e.onselectstart=function(){return!1},e.style.MozUserSelect="none",e.style.KhtmlUserSelect="none",e.unselectable="on"}};return f.webSocket.supported||f.webSocket.loader.resolve(),f;function m(e,t,o){let n=e.toString();return n.length<t?(o||"0").toString().substr(0,1).repeat(t-n.length)+n:n.slice(-t)}function y(){let e=new WebSocket(p+location.host);return e.onmessage=function(e){try{let t=JSON.parse(e.data),o=u[t.requestId];if("error"===t.status)return dialog.ok(t.data),void o.reject(t.data);t.buffer&&(s=$.extend(s,t.buffer)),t.userId&&(f.webSocket.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):cookie.write("userId",t.userId,f.webSocket.options.permanentId&&31536e4));for(let e in g)if(e===t.requestId)return void g[e](t.data);o.resolve(t.data)}catch(e){console.log(e),dialog.ok("unknown-error")}},e.onopen=function(){f.webSocket.onconnect&&f.webSocket.onconnect(),f.webSocket.loader.resolve()},e.onclose=function(){f.webSocket.ondisconnect&&f.webSocket.ondisconnect()&&(d=new y)},e}}();