"use strict";const serverManagerTools=function(){let e={},t=new Event("websocket_onconnect"),o=new Event("websocket_ondisconnect"),r=null,s=[],n={},a,c={},l={},i="https"===location.protocol?"wss://":"ws://",u={cookie:{read:function(e){let t=document.cookie.split("; "),o=escape(e)+"=";for(let e in t)if(e.substr(0,o.length)===o)return unescape(e.substr(o.length))},write:function(e,t,o){document.cookie=escape(e)+"="+escape(t)+(o?"; max-age="+o:"")},delete:function(e){document.cookie=escape(e)+"=; max-age=-1"}},http:{options:{postDelay:10,permanentId:!1},fetch:function(t,o){let a=$.Deferred();if(e[t]&&$.equals(o,e[t].parameters))return a.resolve(e[t].response),e[t].isPermanent||delete e[t],a;let c=(new Date).getTime()+Math.random(),l;n[c]=a,l=localStorage&&localStorage.getItem?localStorage.userId:cookie.read("userId");let i={requestId:c,action:t};return o&&(i.parameters=o),s.push(i),r&&clearTimeout(r),r=setTimeout(function(){clearTimeout(r),r=null;let t={actions:s};l&&(t.userId=l),$.post({method:"POST",url:"/",data:JSON.stringify(t)}).then(function(t){t.userId&&(u.http.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):cookie.write("userId",t.userId,u.http.options.permanentId&&31536e4)),e=$.extend(e,t.buffer);for(let e in t.responses){let o=t.responses[e];if("error"===o.status)return void a.reject(o.data);n[e].resolve(o.data),delete n[e]}},function(e,t){a.reject(e.statusText)}),s=[]},u.http.options.postDelay||10),a}},webSocket:{options:{},loader:$.Deferred(),supported:!!WebSocket,start:function(e){return u.webSocket.optios=e,a=new d,u.webSocket.loader},addListener:function(e,t){l[e]=t},fetch:function(t,o){if(e[t]&&$.equals(o,e[t].parameters)){let o=$.Deferred();return o.resolve(e[t].response),e[t].isPermanent||delete e[t],o}let r={requestId:(new Date).getTime()+Math.random(),action:t},s;(s=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:cookie.read("userId"))&&(r.userId=s),o&&(r.parameters=o);let n=c[r.requestId]=$.Deferred();return 1===a.readyState?a.send(JSON.stringify(r)):n.reject(),n}},server:{loader:$.Deferred(),start:function(e){let t=[];return(e=e||{}).webSocket=!!e.webSocket&&u.webSocket.supported,u.http.options=e,e.webSocket&&t.push(u.webSocket.start(e)),$.when(t).then(function(){e.webSocket?(u.server.fetch=u.webSocket.fetch,u.server.addListener=u.webSocket.addListener,u.server.usingWebSocket=!0):(u.server.fetch=u.http.fetch,u.server.addListener=function(){},u.server.usingWebSocket=!1),u.server.loader.resolve()}),u.server.loader},readStore:function(e,t){let o;if(void 0===(o=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(o)}catch(e){return t}},writeStore:function(e,t,o){o&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),o)},deleteStore:function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}},setUnselectable:function(e){e.onselectstart=function(){return!1},e.style.MozUserSelect="none",e.style.KhtmlUserSelect="none",e.unselectable="on"}};return u.webSocket.supported||u.webSocket.loader.resolve(),u;function d(){let r=new WebSocket(i+location.host);return r.onmessage=function(t){try{let o=JSON.parse(t.data),r=c[o.requestId];if("error"===o.status)return void r.reject(o.data);o.buffer&&(e=$.extend(e,o.buffer)),o.userId&&(u.webSocket.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",o.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",o.userId):cookie.write("userId",o.userId,u.webSocket.options.permanentId&&31536e4));for(let e in l)if(e===o.requestId)return void l[e](o.data);r.resolve(o.data)}catch(e){console.log(e)}},r.onopen=function(){document.dispatchEvent(t),u.webSocket.loader.resolve()},r.onclose=function(){document.dispatchEvent(o)&&(a=new d)},r}}();