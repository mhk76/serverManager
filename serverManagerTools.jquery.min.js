'use strict';const serverManagerTools=function(){let e={},t=null,n=new Event('setdictionarylanguage'),o=[],r=[],a=-1,s={},c=null,l=[],i={},d,u={},g={},p='https'===location.protocol?'wss://':'ws://',f={dictionary:{start:function(){let n=$.Deferred();return $.get('dictionary.json').then(function(o){e=o;for(let n in window.navigator.languages){let o=window.navigator.languages[n];if(e[o]){t=o;break}if(5===o.length&&e[o.substr(0,2)]){t=o.substr(0,2);break}}null===t&&(t=Object.keys(e)[0]),f.dictionary.lang=t,n.resolve()},function(e){throw'Failed to load dictionary'}),n},lang:null,setLang:function(o){return!!e[o]&&(t=o,document.dispatchEvent(n),!0)},get:function(n,o,r){return void 0===r&&'string'==typeof o?e[t]&&e[t][n]||o:void 0===o?e[t]&&e[t][n]||r||n:e[t]&&e[t][n]&&e[t][n][o]||n+o},getLanguages:function(){let t={};for(let n in e)t[n]=e[n]._lang;return Object.keys(t).length>1?t:{}},formatDate:function(n,o){'string'==typeof n&&(n=new Date(n));let r=e[t][o||'_date']||'%yyyy-%mm-%dd',a=n.getMonth()+1,s=n.getDate(),c=n.getHours(),l=n.getMinutes();return-1===r.indexOf('%a')?r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace('%yyyy',n.getFullYear())).replace('%yy',n.getYear())).replace('%dd',m(s,2,'0'))).replace('%d',s)).replace('%mm',m(a,2,'0'))).replace('%m',a)).replace('%hh',m(c,2,'0'))).replace('%h',c)).replace('%nn',m(l,2,'0'))).replace('%n',l):(r=(r=(r=(r=(r=(r=(r=(r=r.replace('%yyyy',n.getFullYear())).replace('%yy',n.getYear())).replace('%mm',m(a,2,'0'))).replace('%m',a)).replace('%dd',m(s,2,'0'))).replace('%d',s)).replace('%nn',m(l,2,'0'))).replace('%n',l),c>=12?(r=r.replace('%a','PM'),c-=12):r=r.replace('%a','AM'),c=0===c?12:c,r=(r=r.replace('%hh',m(c,2,'0'))).replace('%h',c)),r}},showDialog:function(e,t,n){return document.body.style.overflow='hidden',function(s){let c;if(o[s]||(o[s]=$('<div class="smDialog level'+s%3+' ng-hide" data-ng-controller="DialogController"><span class="message"></span><p></p><div class="buttons"></div></div>'),r[s]=$('<div class="smDialogMask level'+s%3+' ng-hide"></div>'),$(document.body).append(o[s]).append(r[s])),$.isArray(e)){c=f.dictionary.get(e[0]);for(let t=1;t<e.length;t++)c=c.replace(e[t].key,f.dictionary.get(e[t].message,e[t].index))}else c=f.dictionary.get(e);let l=o[s],i=r[s],d=l.find('p'),u=l.find('div'),g={},p,m={},h=[];if(l.find('span').text(c),d.empty(),u.empty(),n)for(let e=0;e<n.length;e++){let t=n[e],o=$('<span></span>');switch(o.attr('class',t.class),t.type){case'text':o.text(f.dictionary.get(t.text));break;case'html':o.html(t.html);break;case'input':case'email':case'number':case'range':case'search':{let n=$('<input/>');n.attr('type','input'===t.type?'text':t.type),n.attr('maxlength',t.maxlength),n.attr('min',t.min),n.attr('max',t.max),n.attr('step',t.step),n.attr('value',t.default),t.placeholder&&n.attr('placeholder',f.dictionary.get(t.placeholder)),t.onchange&&n.bind('change',t.onchange),g[t.name||t.type+e]=n,p||(p=n),o.append(n);break}}d.append(o)}t||(t=[{text:'close',default:!0,cancel:!0}]);for(let e=0;e<t.length;e++){let n=t[e],o=$('<button></button>');o.text(f.dictionary.get(n.text,n.index)),o[0].clickEvent=n.onclick,o.on('click',function(){if(this.clickEvent){let e=this.clickEvent(g);if(e)return void(e.then&&e.then(function(){y()}))}y()}),n.default&&(m.Enter=o),n.cancel&&(m.Escape=o),n.hotkey&&(m[n.hotkey]=o),u.append(o)}function k(e){if(-1!==h.indexOf(e.key)&&s===a)return m[e.key][0].click(),e.stopImmediatePropagation(),!0}return Object.keys(m).length>0&&(h=Object.keys(m),window.addEventListener('keydown',k)),i.css({'z-index':1e3+2*s}).show(),l.css({'z-index':1e3+2*s+1}).show(),p&&(p[0].focus(),p[0].select&&p[0].select()),y;function y(){o[s].hide(),r[s].hide(),--a,window.removeEventListener('keydown',k),-1===a&&(document.body.style.overflow='')}}(++a)},dialog:{ok:function(e){f.showDialog(e)},yesNo:function(e,t,n){f.showDialog(e,[{text:'yes',hotkey:f.dictionary.get('yes-key'),default:!0,onclick:t},{text:'no',hotkey:f.dictionary.get('no-key'),cancel:!0,onclick:n}])},input:function(e,t,n,o){n&&!$.isFunction(n)&&(o||(o=n),n=function(){}),f.showDialog(e,[{text:'ok',default:!0,onclick:function(e){return t(e.inputText.val())}},{text:'cancel',cancel:!0,onclick:n}],[{type:'input',name:'inputText',default:o}])}},cookie:{read:function(e){let t=document.cookie.split('; '),n=escape(e)+'=';for(let e in t)if(e.substr(0,n.length)===n)return unescape(e.substr(n.length))},write:function(e,t,n){document.cookie=escape(e)+'='+escape(t)+(n?'; max-age='+n:'')},delete:function(e){document.cookie=escape(e)+'=; max-age=-1'}},http:{options:{postDelay:10,permanentId:!1},fetch:function(e,t){let n=$.Deferred();if(s[e]&&$.equals(t,s[e].parameters))return n.resolve(s[e].response),s[e].isPermanent||delete s[e],n;let o=(new Date).getTime()+Math.random(),r;i[o]=n,r=localStorage&&localStorage.getItem?localStorage.userId:cookie.read('userId');let a={requestId:o,action:e};return t&&(a.parameters=t),l.push(a),c&&clearTimeout(c),c=setTimeout(function(){clearTimeout(c),c=null;let e={actions:l};r&&(e.userId=r),$.post({method:'POST',url:'/',data:JSON.stringify(e)}).then(function(e){e.userId&&(f.http.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem('userId',e.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem('userId',e.userId):cookie.write('userId',e.userId,f.http.options.permanentId&&31536e4)),s=$.extend(s,e.buffer);for(let t in e.responses){let o=e.responses[t];if('error'===o.status)return dialog.ok(o.data),void n.reject(o.data);i[t].resolve(o.data),delete i[t]}},function(e,t){dialog.ok(e.statusText),n.reject(e.statusText)}),l=[]},f.http.options.postDelay||10),n}},webSocket:{options:{},loader:$.Deferred(),onconnect:null,ondisconnect:null,supported:!!WebSocket,start:function(e){return f.webSocket.optios=e,d=new h,f.webSocket.loader},addListener:function(e,t){g[e]=t},fetch:function(e,t){if(s[e]&&$.equals(t,s[e].parameters)){let t=$.Deferred();return t.resolve(s[e].response),s[e].isPermanent||delete s[e],t}let n={requestId:(new Date).getTime()+Math.random(),action:e},o;(o=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:cookie.read('userId'))&&(n.userId=o),t&&(n.parameters=t);let r=u[n.requestId]=$.Deferred();return 1===d.readyState?d.send(JSON.stringify(n)):r.reject(),r}},server:{loader:$.Deferred(),start:function(e){let t=[];return(e=e||{}).webSocket=!!e.webSocket&&f.webSocket.supported,f.http.options=e,e.webSocket&&t.push(f.webSocket.start(e)),$.when(t).then(function(){e.webSocket?(f.server.fetch=f.webSocket.fetch,f.server.addListener=f.webSocket.addListener,f.server.usingWebSocket=!0,f.webSocket.onconnect=e.onconnect,f.webSocket.ondisonnect=e.ondisconnect):(f.server.fetch=f.http.fetch,f.server.addListener=function(){},f.server.usingWebSocket=!1),f.server.loader.resolve()}),f.server.loader},readStore:function(e,t){let n;if(void 0===(n=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(n)}catch(e){return t}},writeStore:function(e,t,n){n&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),n)},deleteStore:function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}},setUnselectable:function(e){e.onselectstart=function(){return!1},e.style.MozUserSelect='none',e.style.KhtmlUserSelect='none',e.unselectable='on'}};return f.webSocket.supported||f.webSocket.loader.resolve(),f;function m(e,t,n){let o=e.toString();return o.length<t?(n||'0').toString().substr(0,1).repeat(t-o.length)+o:o.slice(-t)}function h(){let e=new WebSocket(p+location.host);return e.onmessage=function(e){try{let t=JSON.parse(e.data),n=u[t.requestId];if('error'===t.status)return dialog.ok(t.data),void n.reject(t.data);t.buffer&&(s=$.extend(s,t.buffer)),t.userId&&(f.webSocket.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem('userId',t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem('userId',t.userId):cookie.write('userId',t.userId,f.webSocket.options.permanentId&&31536e4));for(let e in g)if(e===t.requestId)return void g[e](t.data);n.resolve(t.data)}catch(e){console.log(e),dialog.ok('unknown-error')}},e.onopen=function(){f.webSocket.onconnect&&f.webSocket.onconnect(),f.webSocket.loader.resolve()},e.onclose=function(){f.webSocket.ondisconnect&&f.webSocket.ondisconnect()&&(d=new h)},e}}();