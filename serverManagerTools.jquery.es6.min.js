"use strict";exports=function(){let e={},t=[],o=[],r=-1,a={},n=new Event("websocket_onconnect"),s=new Event("dictionary_setlanguage"),c=new Event("websocket_ondisconnect"),l=null,d=[],u={},p=null,g,m={},k={},h="https"===location.protocol?"wss://":"ws://",y={dictionary:{loader:$.Deferred(),start:()=>($.get("dictionary.json").then(e=>{a=e;for(let e in window.navigator.languages){let t=window.navigator.languages[e];if(a[t]){p=t;break}if(5===t.length&&a[t.substr(0,2)]){p=t.substr(0,2);break}}null===p&&(p=Object.keys(a)[0]),y.dictionary.lang=p,y.dictionary.loader.resolve()},e=>{throw"Failed to load dictionary"}),y.dictionary.loader),lang:null,setLang:e=>!!a[e]&&(p=e,document.dispatchEvent(s),!0),get:(e,t,o)=>void 0===o&&"string"==typeof t?a[p]&&a[p][e]||t:void 0===t?a[p]&&a[p][e]||o||e:a[p]&&a[p][e]&&a[p][e][t]||e+t,getLanguages:()=>{let e={};for(let t in a)e[t]=a[t]._lang;return Object.keys(e).length>1?e:{}},formatDate:(e,t)=>{"string"==typeof e&&(e=new Date(e));let o=a[p][t||"_date"]||"%yyyy-%mm-%dd",r=e.getMonth()+1,n=e.getDate(),s=e.getHours(),c=e.getMinutes();return-1===o.indexOf("%a")?o=(o=(o=(o=(o=(o=(o=(o=(o=(o=o.replace("%yyyy",e.getFullYear())).replace("%yy",e.getYear())).replace("%dd",S(n,2,"0"))).replace("%d",n)).replace("%mm",S(r,2,"0"))).replace("%m",r)).replace("%hh",S(s,2,"0"))).replace("%h",s)).replace("%nn",S(c,2,"0"))).replace("%n",c):(o=(o=(o=(o=(o=(o=(o=(o=o.replace("%yyyy",e.getFullYear())).replace("%yy",e.getYear())).replace("%mm",S(r,2,"0"))).replace("%m",r)).replace("%dd",S(n,2,"0"))).replace("%d",n)).replace("%nn",S(c,2,"0"))).replace("%n",c),s>=12?(o=o.replace("%a","PM"),s-=12):o=o.replace("%a","AM"),s=0===s?12:s,o=(o=o.replace("%hh",S(s,2,"0"))).replace("%h",s)),o}},showDialog:(e,a,n)=>(document.body.style.overflow="hidden",function(s){let c;t[s]||(t[s]=$('<div class="smDialog level'+s%3+'"><span class="message"></span><p></p><div class="buttons"></div></div>'),o[s]=$('<div class="smDialogMask level'+s%3+'"></div>'),$(document.body).append(t[s]).append(o[s])),c=Array.isArray(e)?e.reduce((e,t)=>e.replace(t[i].key,y.dictionary.get(t[i].message,t[i].index)),y.dictionary.get(e[0])):y.dictionary.get(e);let l=t[s],d=o[s],u=l.find("p"),p=l.find("div"),g={},m,k={},h=[];function S(e){if(h.includes(e.key)&&s===r)return k[e.key][0].click(),e.stopImmediatePropagation(),!0}return l.find("span").text(c),u.empty(),p.empty(),n&&n.forEach(e=>{let t=$("<span></span>");switch(t.attr("class",e.class),e.type){case"text":t.text(y.dictionary.get(e.text));break;case"html":t.html(e.html);break;case"input":case"email":case"number":case"range":case"search":{let o=$("<input/>");o.attr("type","input"===e.type?"text":e.type),o.attr("maxlength",e.maxlength),o.attr("min",e.min),o.attr("max",e.max),o.attr("step",e.step),o.attr("value",e.default),e.placeholder&&o.attr("placeholder",y.dictionary.get(e.placeholder)),e.onchange&&o.bind("change",e.onchange),g[e.name||e.type+i]=o,m||(m=o),t.append(o);break}}u.append(t)}),a||(a=[{text:"close",default:!0,cancel:!0}]),a.foreach(e=>{let t=$("<button></button>");t.text(y.dictionary.get(e.text,e.index)),t[0].clickEvent=e.onclick,t.on("click",()=>{if(this.clickEvent){let e=this.clickEvent(g);if(e)return void(e.then&&e.then(()=>{f()}))}f()}),e.default&&(k.Enter=t),e.cancel&&(k.Escape=t),e.hotkey&&(k[e.hotkey]=t),p.append(t)}),Object.keys(k).length>0&&(h=Object.keys(k),window.addEventListener("keydown",S)),d.css({"z-index":1e3+2*s}).show(),l.css({"z-index":1e3+2*s+1}).show(),m&&(m[0].focus(),m[0].select&&m[0].select()),f;function f(){t[s].hide(),o[s].hide(),--r,window.removeEventListener("keydown",S),-1===r&&(document.body.style.overflow="")}}(++r)),dialog:{ok:e=>{y.showDialog(e)},yesNo:(e,t,o)=>{y.showDialog(e,[{text:"yes",hotkey:y.dictionary.get("yes-key"),default:!0,onclick:t},{text:"no",hotkey:y.dictionary.get("no-key"),cancel:!0,onclick:o}])},input:(e,t,o,r)=>{o&&!$.isFunction(o)&&(r||(r=o),o=(()=>{})),y.showDialog(e,[{text:"ok",default:!0,onclick:e=>t(e.inputText.val())},{text:"cancel",cancel:!0,onclick:o}],[{type:"input",name:"inputText",default:r}])}},cookie:{read:e=>{let t=escape(e)+"=";document.cookie.split("; ").foreach(e=>{if(e.substr(0,t.length)===t)return unescape(e.substr(t.length))})},write:(e,t,o)=>{document.cookie=escape(e)+"="+escape(t)+(o?"; max-age="+o:"")},delete:e=>{document.cookie=escape(e)+"=; max-age=-1"}},http:{options:{postDelay:10,permanentId:!1},fetch:(t,o)=>{let r=$.Deferred();if(e[t]&&$.equals(o,e[t].parameters))return r.resolve(e[t].response),e[t].isPermanent||delete e[t],r;let a=(new Date).getTime()+Math.random(),n;u[a]=r,n=localStorage&&localStorage.getItem?localStorage.userId:cookie.read("userId");let s={requestId:a,action:t};return o&&(s.parameters=o),d.push(s),l&&clearTimeout(l),l=setTimeout(()=>{clearTimeout(l),l=null;let t={actions:d};n&&(t.userId=n),$.post({method:"POST",url:"/",data:JSON.stringify(t)}).then(t=>{t.userId&&(y.http.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):cookie.write("userId",t.userId,y.http.options.permanentId&&31536e4)),e=$.extend(e,t.buffer);for(let e in t.responses){let o=t.responses[e];if("error"===o.status)return dialog.ok(o.data),void r.reject(o.data);u[e].resolve(o.data),delete u[e]}},(e,t)=>{dialog.ok(e.statusText),r.reject(e.statusText)}),d=[]},y.http.options.postDelay||10),r}},webSocket:{options:{},loader:$.Deferred(),onconnect:null,ondisconnect:null,supported:!!WebSocket,start:e=>(y.webSocket.optios=e,g=new f,y.webSocket.loader),addListener:(e,t)=>{k[e]=t},fetch:(t,o)=>{if(e[t]&&$.equals(o,e[t].parameters)){let o=$.Deferred();return o.resolve(e[t].response),e[t].isPermanent||delete e[t],o}let r={requestId:(new Date).getTime()+Math.random(),action:t},a;(a=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:cookie.read("userId"))&&(r.userId=a),o&&(r.parameters=o);let n=m[r.requestId]=$.Deferred();return 1===g.readyState?g.send(JSON.stringify(r)):n.reject(),n}},server:{loader:$.Deferred(),start:e=>{let t=[];return(e=e||{}).webSocket=!!e.webSocket&&y.webSocket.supported,y.http.options=e,e.webSocket&&t.push(y.webSocket.start(e)),$.when(t).then(()=>{e.webSocket?(y.server.fetch=y.webSocket.fetch,y.server.addListener=y.webSocket.addListener,y.server.usingWebSocket=!0,y.webSocket.onconnect=e.onconnect,y.webSocket.ondisonnect=e.ondisconnect):(y.server.fetch=y.http.fetch,y.server.addListener=(()=>{}),y.server.usingWebSocket=!1),y.server.loader.resolve()}),y.server.loader},readStore:(e,t)=>{let o;if(void 0===(o=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(o)}catch(e){return t}},writeStore:(e,t,o)=>{o&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),o)},deleteStore:e=>{localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}}};return y.webSocket.supported||y.webSocket.loader.resolve(),y;function S(e,t,o){let r=e.toString();return r.length<t?(o||"0").toString().substr(0,1).repeat(t-r.length)+r:r.slice(-t)}function f(){let t=new WebSocket(h+location.host);return t.onmessage=(t=>{try{let o=JSON.parse(t.data),r=m[o.requestId];if("error"===o.status)return dialog.ok(o.data),void r.reject(o.data);o.buffer&&(e=$.extend(e,o.buffer)),o.userId&&(y.webSocket.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",o.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",o.userId):cookie.write("userId",o.userId,y.webSocket.options.permanentId&&31536e4));for(let e in k)if(e===o.requestId)return void k[e](o.data);r.resolve(o.data)}catch(e){console.log(e),dialog.ok("unknown-error")}}),t.onopen=(()=>{document.dispatchEvent(n),y.webSocket.onconnect&&y.webSocket.onconnect(),y.webSocket.loader.resolve()}),t.onclose=(()=>{document.dispatchEvent(c)?g=new f:y.webSocket.ondisconnect&&y.webSocket.ondisconnect()&&(g=new f)}),t}}();