"use strict";angular.module("ServerManagerAngularTools",[]).service("cookie",function(){this.read=function(e){let t=document.cookie.split("; "),o=escape(e)+"=";for(let e in t)if(e.substr(0,o.length)===o)return unescape(e.substr(o.length))},this.write=function(e,t,o){document.cookie=escape(e)+"="+escape(t)+(o?"; max-age="+o:"")},this.delete=function(e){document.cookie=escape(e)+"=; max-age=-1"}}).service("http",function(e,t,o,r){let s=this,n={},a=null,i=[],l={};s.options={httpDelay:10},s.start=function(e){s.options=e},s.fetch=function(c,u){let d=t.defer();if(n[c]&&angular.equals(u,n[c].parameters))return d.resolve(n[c].response),n[c].isPermanent||delete n[c],d.promise;let g=(new Date).getTime()+Math.random(),f;l[g]=d,f=localStorage&&localStorage.getItem?localStorage.userId:r.read("userId");let S={requestId:g,action:c};return u&&(S.parameters=u),i.push(S),a&&o.cancel(a),a=o(function(){o.cancel(a),a=null;let t={actions:i};f&&(t.userId=f),e({method:"POST",url:"/",data:t}).then(function(e){let t=e.data;t.userId&&(s.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):r.write("userId",t.userId,s.options.permanentId&&31536e4)),n=angular.extend(n,t.buffer);for(let e in t.responses){let o=t.responses[e];if("error"===o.status)return void d.reject(o.data);l[e].resolve(o.data),delete l[e]}},function(e,t){d.reject(e.statusText)}),i=[]},s.options.httpDelay||10),d.promise}}).service("webSocket",function(e,t,o){let r=this,s=e.defer(),n;if(r.options={},r.loader=s.promise,r.supported=!!WebSocket,!r.supported)return void s.resolve();let a={},i={},l={},c="https"===location.protocol?"wss://":"ws://";function u(){let e=new WebSocket(c+location.host);return e.onmessage=function(e){try{let t=JSON.parse(e.data),s=a[t.requestId];if("error"===t.status)return void s.reject(t.data);t.buffer&&(l=angular.extend(l,t.buffer)),t.userId&&(r.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem("userId",t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("userId",t.userId):o.write("userId",t.userId,r.options.permanentId&&31536e4));for(let e in i)if(e===t.requestId)return void i[e](t.data);s.resolve(t.data)}catch(e){console.log(e)}},e.onopen=function(){t.$broadcast("websocket_onconnect"),s.resolve()},e.onclose=function(){t.$broadcast("websocket_ondisconnect")},e}t.$on("websocket_connect",function(){n=new u}),r.start=function(e){return r.options=e,n=new u,r.loader},r.addListener=function(e,t){i[e]=t},r.fetch=function(t,r){if(l[t]&&angular.equals(r,l[t].parameters)){let o=e.defer();return o.resolve(l[t].response),l[t].isPermanent||delete l[t],o.promise}let s={requestId:(new Date).getTime()+Math.random(),action:t},i;(i=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:o.read("userId"))&&(s.userId=i),r&&(s.parameters=r);let c=a[s.requestId]=e.defer();return 1===n.readyState?n.send(JSON.stringify(s)):c.reject(),c.promise}}).service("server",function(e,t,o){let r=this,s=e.defer(),n;r.loader=s.promise,r.start=function(n){let a=[];n.webSocket=n.webSocket&&o.supported,t.start(n),n.webSocket&&a.push(o.start(n)),e.all(a).then(function(){n.webSocket?(r.fetch=o.fetch,r.addListener=o.addListener(),r.usingWebSocket=!0):(r.fetch=t.fetch,r.addListener=function(){},r.usingWebSocket=!1),s.resolve()})},r.readStore=function(e,t){let o;if(void 0===(o=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(o)}catch(e){return t}},r.writeStore=function(e,t,o){o&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),o)},r.deleteStore=function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}});