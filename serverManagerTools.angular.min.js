'use strict';angular.module('ServerManagerAngularTools',[]).service('dictionary',function(e,t,n){let o=this,r={},a=t.defer(),i=null;function l(e,t,n){let o=e.toString();return o.length<t?(n||'0').toString().substr(0,1).repeat(t-o.length)+o:o.slice(-t)}o.lang=null,o.setLang=function(t){return!!r[t]&&(i=t,e.$broadcast('dictionary-setLanguage',t),!0)},o.get=function(e,t,n){return void 0===n&&'string'==typeof t?r[i]&&r[i][e]||t:void 0===t?r[i]&&r[i][e]||n||e:r[i]&&r[i][e]&&r[i][e][t]||e+t},o.getLanguages=function(){let e={};for(let t in r)e[t]=r[t]._lang;return Object.keys(e).length>1?e:{}},o.formatDate=function(e,t){'string'==typeof e&&(e=new Date(e));let n=o.get(t||'_date','%yyyy-%mm-%dd'),r=e.getMonth()+1,a=e.getDate(),i=e.getHours(),s=e.getMinutes();return-1===n.indexOf('%a')?n=(n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace('%yyyy',e.getFullYear())).replace('%yy',e.getYear())).replace('%dd',l(a,2,'0'))).replace('%d',a)).replace('%mm',l(r,2,'0'))).replace('%m',r)).replace('%hh',l(i,2,'0'))).replace('%h',i)).replace('%nn',l(s,2,'0'))).replace('%n',s):(n=(n=(n=(n=(n=(n=(n=(n=n.replace('%yyyy',e.getFullYear())).replace('%yy',e.getYear())).replace('%mm',l(r,2,'0'))).replace('%m',r)).replace('%dd',l(a,2,'0'))).replace('%d',a)).replace('%nn',l(s,2,'0'))).replace('%n',s),i>=12?(n=n.replace('%a','PM'),i-=12):n=n.replace('%a','AM'),i=0===i?12:i,n=(n=n.replace('%hh',l(i,2,'0'))).replace('%h',i)),n},o.loader=a.promise,n.get('dictionary.json').then(function(e){r=e.data;for(let e in window.navigator.languages){let t=window.navigator.languages[e];if(r[t]){i=t;break}if(5===t.length&&r[t.substr(0,2)]){i=t.substr(0,2);break}}null===i&&(i=Object.keys(r)[0]),o.lang=i,a.resolve()},function(e){throw'Failed to load dictionary'})}).factory('showDialog',function(e,t){let n=[],o=[],r=-1,a={},i=[];function l(e){-1!==i.indexOf(e.key)&&a[e.key][0].click()}return function(e,s,c){++r;let u=this,d;if(document.body.style.overflow='hidden',n[r]||(n[r]=$('<div class="smDialog level'+r%3+' ng-hide" data-ng-controller="DialogController"><span class="message"></span><p></p><div class="buttons"></div></div>'),o[r]=$('<div class="smDialogMask level'+r%3+' ng-hide"></div>'),$(document.body).append(n[r]).append(o[r])),angular.isArray(e)){d=t.get(e[0]);for(let n=1;n<e.length;n++)d=d.replace(e[n].key,t.get(e[n].message,e[n].index))}else d=t.get(e);let g=n[r],f=o[r],p=g.find('p'),m=g.find('div'),h={},y;if(a={},i=[],g.find('span').text(d),p.empty(),m.empty(),c)for(let e=0;e<c.length;e++){let n=c[e],o=$('<span></span>');switch(o.attr('class',n.class),n.type){case'text':o.text(t.get(n.text));break;case'html':o.html(n.html);break;case'input':case'email':case'number':case'range':case'search':{let r=$('<input/>');r.attr('type','input'===n.type?'text':n.type),r.attr('maxlength',n.maxlength),r.attr('min',n.min),r.attr('max',n.max),r.attr('step',n.step),r.attr('value',n.default),n.placeholder&&r.attr('placeholder',t.get(n.placeholder)),n.onchange&&r.bind('change',n.onchange),h[n.name||n.type+e]=r,y||(y=r),o.append(r);break}}p.append(o)}s||(s=[{text:'close',default:!0,cancel:!0}]);for(let e=0;e<s.length;e++){let n=s[e],o=$('<button></button>');o.text(t.get(n.text,n.index)),o[0].clickEvent=n.onclick,o.on('click',function(){if(this.clickEvent){let e=this.clickEvent(h);if(e)return void(e.then&&e.then(function(){k()}))}k()}),n.default&&(a.Enter=o),n.cancel&&(a.Escape=o),n.hotkey&&(a[n.hotkey]=o),m.append(o)}return Object.keys(a).length>0&&(i=Object.keys(a),window.addEventListener('keydown',l)),f.css({'z-index':1e3+2*r}).toggleClass('ng-hide',!1),g.css({'z-index':1e3+2*r+1}).toggleClass('ng-hide',!1),y&&(y[0].focus(),y[0].select&&y[0].select()),k;function k(){n[r].toggleClass('ng-hide',!0),o[r].toggleClass('ng-hide',!0),--r,window.removeEventListener('keydown',l),-1===r&&(document.body.style.overflow='')}}}).service('dialog',function(e,t){this.ok=function(t){e(t)},this.yesNo=function(n,o,r){e(n,[{text:'yes',hotkey:'Key'+t.get('yes-key'),default:!0,onclick:o},{text:'no',hotkey:'Key'+t.get('no-key'),cancel:!0,onclick:r}])},this.input=function(t,n,o,r){o&&!angular.isFunction(o)&&(r||(r=o),o=function(){}),e(t,[{text:'ok',default:!0,onclick:function(e){return n(e.inputText.val())}},{text:'cancel',cancel:!0,onclick:o}],[{type:'input',name:'inputText',default:r}])}}).service('cookie',function(){this.read=function(e){let t=document.cookie.split('; '),n=escape(e)+'=';for(let e in t)if(e.substr(0,n.length)===n)return unescape(e.substr(n.length))},this.write=function(e,t,n){document.cookie=escape(e)+'='+escape(t)+(n?'; max-age='+n:'')},this.delete=function(e){document.cookie=escape(e)+'=; max-age=-1'}}).service('http',function(e,t,n,o,r){let a=this,i={},l=null,s=[],c={};a.options={httpDelay:10},a.start=function(e){a.options=e},a.fetch=function(u,d){let g=t.defer();if(i[u]&&angular.equals(d,i[u].parameters))return g.resolve(i[u].response),i[u].isPermanent||delete i[u],g.promise;let f=(new Date).getTime()+Math.random(),p;c[f]=g,p=localStorage&&localStorage.getItem?localStorage.userId:o.read('userId');let m={requestId:f,action:u};return d&&(m.parameters=d),s.push(m),l&&n.cancel(l),l=n(function(){n.cancel(l),l=null;let t={actions:s};p&&(t.userId=p),e({method:'POST',url:'/',data:t}).then(function(e){let t=e.data;t.userId&&(a.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem('userId',t.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem('userId',t.userId):o.write('userId',t.userId,a.options.permanentId&&31536e4)),i=angular.extend(i,t.buffer);for(let e in t.responses){let n=t.responses[e];if('error'===n.status)return r.ok(n.data),void g.reject(n.data);c[e].resolve(n.data),delete c[e]}},function(e,t){r.ok(e.statusText),g.reject(e.statusText)}),s=[]},a.options.httpDelay||10),g.promise}}).service('webSocket',function(e,t,n){let o=this,r=e.defer(),a;if(o.options={},o.loader=r.promise,o.onConnect=null,o.onDisconnect=null,o.supported=!!WebSocket,!o.supported)return void r.resolve();let i={},l={},s={},c='https'===location.protocol?'wss://':'ws://';function u(){let e=new WebSocket(c+location.host);return e.onmessage=function(e){try{let r=JSON.parse(e.data),a=i[r.requestId];if('error'===r.status)return n.ok(r.data),void a.reject(r.data);r.buffer&&(s=angular.extend(s,r.buffer)),r.userId&&(o.options.permanentId&&localStorage&&localStorage.setItem?localStorage.setItem('userId',r.userId):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem('userId',r.userId):t.write('userId',r.userId,o.options.permanentId&&31536e4));for(let e in l)if(e===r.requestId)return void l[e](r.data);a.resolve(r.data)}catch(e){console.log(e),n.ok('unknown-error')}},e.onopen=function(){o.onConnect&&o.onConnect(),r.resolve()},e.onclose=function(){o.onDisconnect&&o.onDisconnect()&&(a=new u)},e}o.start=function(e){return o.options=e,a=new u,o.loader},o.addListener=function(e,t){l[e]=t},o.fetch=function(n,o){if(s[n]&&angular.equals(o,s[n].parameters)){let t=e.defer();return t.resolve(s[n].response),s[n].isPermanent||delete s[n],t.promise}let r={requestId:(new Date).getTime()+Math.random(),action:n},l;(l=localStorage&&localStorage.getItem?localStorage.userId:sessionlStorage&&sessionlStorage.getItem?sessionlStorage.userId:t.read('userId'))&&(r.userId=l),o&&(r.parameters=o);let c=i[r.requestId]=e.defer();return 1===a.readyState?a.send(JSON.stringify(r)):c.reject(),c.promise}}).service('server',function(e,t,n){let o=this,r=e.defer(),a;o.loader=r.promise,o.start=function(a){let i=[];a.webSocket=a.webSocket&&n.supported,t.start(a),a.webSocket&&i.push(n.start(a)),e.all(i).then(function(){a.webSocket?(o.fetch=n.fetch,o.addListener=n.addListener(),o.usingWebSocket=!0,o.onConnect=a.onConnect,o.onDisonnect=a.onDisconnect):(o.fetch=t.fetch,o.addListener=function(){},o.usingWebSocket=!1),r.resolve()})},o.readStore=function(e,t){let n;if(void 0===(n=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(n)}catch(e){return t}},o.writeStore=function(e,t,n){n&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),n)},o.deleteStore=function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)}}).directive('unselectable',function(){return{restrict:'A',link:function(e,t){let n=t[0];n.onselectstart=function(){return!1},n.style.MozUserSelect='none',n.style.KhtmlUserSelect='none',n.unselectable='on'}}}).directive('dicText',function(e,t){return{restrict:'A',link:function(e,n,o){t.loader.then(function(){n.html(t.get(o.dicText,o.dicTextIndex))}),e.$on('dictionary-setLanguage',function(){n.html(t.get(o.dicText,o.dicTextIndex))})}}}).directive('dicTitle',function(e,t){return{restrict:'A',link:function(e,n,o){t.loader.then(function(){n.attr('title',t.get(o.dicTitle,o.dicTitleIndex))}),e.$on('dictionary-setLanguage',function(){n.attr('title',t.get(o.dicText,o.dicTitleIndex))})}}}).directive('asDate',function(){return{require:'ngModel',restrict:'A',link:function(e,t,n,o){o.$formatters.length=0,o.$parsers.length=0,o.$formatters.push(function(e){let t=new Date(e);return t.getFullYear()+'-'+(t.getMonth()+1).padLeft(2)+'-'+t.getDate().padLeft(2)});let r=e.$watch(n.ngModel,function(t){t&&(e.ngModel=new Date(t))});e.$on('$destroy',function(){r()})}}}).filter('dictionary',function(e){let t=function(t){return e.get(t)};return t.$stateful=!0,t}).filter('formatDate',function(e){let t=function(t){let n=new Date(t);return'Invalid date'==n?'':e.formatDate(n)};return t.$stateful=!0,t}).filter('formatDateTime',function(e){let t=function(t){let n=new Date(t);return'Invalid date'==n?'':e.formatDate(n,'_datetime')};return t.$stateful=!0,t});