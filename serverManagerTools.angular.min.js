"use strict";angular.module("ServerManagerAngularTools",[]).service("cookie",function(){this.read=function(e){let t=document.cookie.split("; "),s=escape(e)+"=";for(let e in t)if(e.substr(0,s.length)===s)return unescape(e.substr(s.length))},this.write=function(e,t,s){document.cookie=escape(e)+"="+escape(t)+(s?"; max-age="+s:"")},this.delete=function(e){document.cookie=escape(e)+"=; max-age=-1"}}).service("http",function(e,t,s,o){let n=this,r={},i=null,a=[],c={};n.options={httpDelay:10},n.start=function(e){n.options=e},n.fetch=function(l,d){let u=t.defer();if(r[l]&&angular.equals(d,r[l].parameters))return u.resolve(r[l].response),r[l].isPermanent||delete r[l],u.promise;let f=(new Date).getTime()+Math.random(),g;c[f]=u,g=sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:o.read("sessionId");let S={requestId:f,action:l};return d&&(S.parameters=d),a.push(S),i&&s.cancel(i),i=s(function(){s.cancel(i),i=null;let t={actions:a};g&&(t.sessionId=g),e({method:"POST",url:"/",data:t}).then(function(e){let t=e.data;sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("sessionId",t.sessionId):o.write("sessionId",t.sessionId),r=angular.extend(r,t.buffer);for(let e in t.responses){let s=t.responses[e];if("error"===s.status)return void u.reject(s.data);c[e].resolve(s.data),delete c[e]}},function(e,t){u.reject(e.statusText)}),a=[]},n.options.httpDelay||10),u.promise}}).service("webSocket",function(e,t,s){let o=this,n=e.defer(),r;if(o.options={},o.loader=n.promise,o.supported=!!WebSocket,!o.supported)return void n.resolve();let i={},a={},c={},l="https"===location.protocol?"wss://":"ws://";function d(){let e=new WebSocket(l+location.host);return e.onmessage=function(e){try{let t=JSON.parse(e.data),o=i[t.requestId];if("error"===t.status)return void o.reject(t.data);t.buffer&&(c=angular.extend(c,t.buffer)),sessionStorage&&sessionStorage.setItem?sessionStorage.setItem("sessionId",t.sessionId):s.write("sessionId",t.sessionId);for(let e in a)if(e===t.requestId)return void a[e](t.data);o.resolve(t.data)}catch(e){console.log(e)}},e.onopen=function(){t.$broadcast("websocket_onconnect"),n.resolve()},e.onclose=function(){t.$broadcast("websocket_ondisconnect")},e}t.$on("websocket_connect",function(){r=new d}),o.start=function(e){return o.options=e,r=new d,o.loader},o.addListener=function(e,t){a[e]=t},o.fetch=function(t,o){if(c[t]&&angular.equals(o,c[t].parameters)){let s=e.defer();return s.resolve(c[t].response),c[t].isPermanent||delete c[t],s.promise}let n={requestId:(new Date).getTime()+Math.random(),action:t},a;(a=sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:s.read("sessionId"))&&(n.sessionId=a),o&&(n.parameters=o);let l=i[n.requestId]=e.defer();return 1===r.readyState?r.send(JSON.stringify(n)):l.reject(),l.promise}}).service("server",function(e,t,s){let o=this,n=e.defer(),r;o.loader=n.promise,o.start=function(r){let i=[];r.webSocket=r.webSocket&&s.supported,t.start(r),r.webSocket&&i.push(s.start(r)),e.all(i).then(function(){r.webSocket?(o.fetch=s.fetch,o.addListener=s.addListener(),o.usingWebSocket=!0):(o.fetch=t.fetch,o.addListener=function(){},o.usingWebSocket=!1),n.resolve()})},o.readStore=function(e,t){let s;if(void 0===(s=localStorage&&localStorage.getItem?localStorage.getItem(e):cookie.read(e)))return t;try{return JSON.parse(s)}catch(e){return t}},o.writeStore=function(e,t,s){s&&localStorage&&localStorage.setItem?localStorage.setItem(e,JSON.stringify(t)):sessionStorage&&sessionStorage.setItem?sessionStorage.setItem(e,JSON.stringify(t)):cookie.write(e,JSON.stringify(t),s)},o.deleteStore=function(e){localStorage&&localStorage.deleteItem?localStorage.deleteItem(e):cookie.delete(e)},o.sessionId=function(){return sessionStorage&&sessionStorage.getItem?sessionStorage.sessionId:cookie.read("sessionId")}});